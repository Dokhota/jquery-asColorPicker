/*! asColorInput - v0.1.3 - 2014-05-09
* https://github.com/amazingSurge/jquery-asColorInput
* Copyright (c) 2014 amazingSurge; Licensed GPL */
(function(t){t.asColorInput.registerComponent("gradient",{degree:1,count:0,markers:[],current:null,init:function(e){var i=this,a='<div class="'+e.namespace+'-gradient-controll">'+'<a href="#" class="'+e.namespace+'-gradient-trigger">Gradient</a>'+'<a href="#" class="'+e.namespace+'-gradient-cancel">Cancel</a>'+"</div>"+'<div class="'+e.namespace+'-gradient">'+'<div class="'+e.namespace+'-gradient-panel">'+'<div class="'+e.namespace+'-gradient-markers"></div>'+"</div>"+'<div class="'+e.namespace+'-gradient-wheel">'+"<i></i>"+"</div>"+'<input class="'+e.namespace+'-gradient-degree" type="text" value="360" size="3" />'+"</div>";this.api=e,this.classes={show:e.namespace+"-gradient"+"_show",marker:e.namespace+"-gradient-marker",active:e.namespace+"-gradient-marker_active"},this.isOpened=!1,this.initialized=!1,this.$doc=t(document),this.$template=t(a).appendTo(e.$picker),this.$controll=this.$template.eq(0),this.$trigger=this.$controll.find("."+e.namespace+"-gradient-trigger"),this.$cancel=this.$controll.find("."+e.namespace+"-gradient-cancel"),this.$gradient=this.$template.eq(1),this.$panel=this.$gradient.find("."+e.namespace+"-gradient-panel"),this.$markers=this.$gradient.find("."+e.namespace+"-gradient-markers"),this.$wheel=this.$gradient.find("."+e.namespace+"-gradient-wheel"),this.$pointer=this.$wheel.find("i"),this.$degree=this.$gradient.find("."+e.namespace+"-gradient-degree"),this.$trigger.on("click",function(){return i.isOpened?(i.$gradient.removeClass(i.classes.show),i.setGradient(),e.isGradient=!1,e.set(e.originalColor)):(i.$gradient.addClass(i.classes.show),e.isGradient=!0,i.makeGradient()),i.isOpened=!i.isOpened,!1}),this.$cancel.on("click",function(){return e.color.from(e.originalColor),e.update({}),i.retrieve(),!1}),this.$markers.on("mousedown.asColorInput",function(t){var e=t.which?3===t.which:2===t.button;if(e)return!1;var a=t.pageX-i.$markers.offset().left,o=Math.round(100*(a/i.width));return i.makeMarker("#fff",o),i.makeGradient(),!1}),this.$wheel.on("mousedown.asColorInput",function(t){var e=t.which?3===t.which:2===t.button;return e?!1:(i.wheelMousedown(t),!1)}),e.$element.on("asColorInput::ready",function(){i.width=i.$markers.width()}),e.$element.on("asColorInput::change",function(t,a){i.current&&e.isGradient&&(i.current.setColor(a.color.toRGBA()),i.makeGradient())}),e.$element.on("asColorInput::close",function(){return e.isGradient&&i.setGradient(),!1}),this.$degree.on("blur.asColorInput",function(){var t=parseInt(this.value,10);return i.setDegree(t),!1}).on("keydown.asColorInput",function(e){var i=e.keyCode||e.which;return 13===i?(t(this).blur(),!1):void 0}),this.makeMarker("#fff",0),this.makeMarker("#000",100),setTimeout(function(){i.setDegree(0),i.initialized=!0},0)},mousedown:function(e,i){var a,o=t(i).data("id");t.each(this.markers,function(t,e){e._id===o&&(a=e)}),this.current=a;var s,n=t(i).position().left,r=e.pageX,h=this.api;return h.makeUnselectable(),h.set(a.color),this.mousemove=function(t){s=t.pageX||r;var e=n+s-r;return this.move(a,e),!1},this.mouseup=function(){return t(document).off({mousemove:this.mousemove,mouseup:this.mouseup}),h.cancelUnselectable(),!1},t(document).on({mousemove:t.proxy(this.mousemove,this),mouseup:t.proxy(this.mouseup,this)}),t(i).focus(),!1},move:function(t,e){e=Math.max(0,Math.min(this.width,e));var i=Math.round(100*(e/this.width));t.setPercent(i),this.makeGradient()},makeMarker:function(e,i){var a=this,o=this.$doc,s=function(){this.color=e,this.percent=i,this._id=++a.count,this.$element=t('<span class="'+a.classes.marker+'"><i></i></span>').attr("tabindex",0).data("id",this._id),this.$element.appendTo(a.$markers),this.$element.on("mousedown.asColorInput",function(t){var e=t.which?3===t.which:2===t.button;return e?!1:(a.mousedown.call(a,t,this),!1)})};s.prototype.setColor=function(t){this.color=t,this.$element.find("i").css({background:t})},s.prototype.setPercent=function(t){this.percent=t,this.$element.css({left:t+"%"})};var n=new s;return n.setPercent(i),n.setColor(e),this.markers.push(n),this.current=n,n.hasBinded=!1,n.$element.on("focus",function(){n.hasBinded||(o.on("keydown."+n._id,function(t){var e=t.keyCode||t.which;46===e&&(a.del(n),a.makeGradient())}),n.$element.addClass(a.classes.active),n.hasBinded=!0)}).on("blur",function(){o.off("keydown."+n._id),n.$element.removeClass(a.classes.active),n.hasBinded=!1}),n},makeGradient:function(){var e=this.markers,i=this.api,a=this,o="gradient("+this.degree+"deg,",s="",n="";e.sort(function(t,e){return t.percent>e.percent}),e.map(function(t,e,i){o+=t.color+" "+t.percent+"%,",e===i.length-1?(s+="color-stop("+t.percent/100+","+t.color+")",n+=t.color+" "+t.percent+"%"):(s+="color-stop("+t.percent/100+","+t.color+"),",n+=t.color+" "+t.percent+"%,")}),o=o.substring(0,o.length-1),o+=")",i.gradient=o,i._trigger("gradientChange",o),i.$element.val(o);var r=["-moz-linear-gradient(left, "+n+")","-webkit-gradient(linear, left top, right top, "+s+")","-webkit-linear-gradient(left, "+n+")","-o-linear-gradient(left, "+n+")"];return t.each(r,function(t,e){a.$panel[0].style.backgroundImage=e}),o},setGradient:function(){var t=this;this.origin={},this.origin.markers=[],this.markers.map(function(e){var i={color:e.color,percent:e.percent};t.origin.markers.push(i)}),this.origin.degree=this.degree},retrieve:function(){var t=this;t.markers.map(function(t){t.$element.blur(),t.$element.remove()}),t.markers=[],t.origin?(t.origin.markers.map(function(e){t.makeMarker(e.color,e.percent)}),t.setDegree(t.origin.degree)):(t.makeMarker("#fff",0),t.makeMarker("#000",100),t.setDegree(0))},getPosition:function(t,e){var i=this.r,a=t/Math.sqrt(t*t+e*e)*i,o=e/Math.sqrt(t*t+e*e)*i;return{x:a,y:o}},calDegree:function(t,e){var i=Math.round(Math.atan(Math.abs(e/t))*(180/Math.PI));return 0>=t&&e>0?180-i:0>=t&&0>=e?i+180:t>0&&0>=e?360-i:t>0&&e>0?i:void 0},_setDegree:function(t){this.degree=t,this.$degree.val(t),this.initialized&&this.makeGradient()},setDegree:function(t){if(this.degree===t)return!1;var e=this.r||this.$wheel.width()/2,i=this.calPointer(t,e);this.$pointer.css({left:i.x,top:i.y}),this._setDegree(t)},calPointer:function(t,e){var i=Math.cos(t*Math.PI/180)*e,a=Math.sin(t*Math.PI/180)*e;return{x:e+i,y:e-a}},wheelMousedown:function(e){var i=this.$wheel.offset(),a=this.$wheel.width()/2,o=i.left+a,s=i.top+a,n=this.$doc;this.r=a,this.wheelMove=function(t){var e=t.pageX-o,i=s-t.pageY,n=this.getPosition(e,i),r=this.calDegree(n.x,n.y);this._setDegree(r);var h=this.calPointer(r,a);this.$pointer.css({left:h.x,top:h.y})},this.wheelMouseup=function(){return n.off({mousemove:this.wheelMove,mouseup:this.wheelMouseup}),!1},n.on({mousemove:t.proxy(this.wheelMove,this),mouseup:t.proxy(this.wheelMouseup,this)}),this.wheelMove(e)},del:function(t){t.$element.blur(),t.$element.remove(),this.markers.splice(this.markers.indexOf(t),1)},destory:function(){this.$element.off("click"),this.$element.remove()}})})(jQuery);