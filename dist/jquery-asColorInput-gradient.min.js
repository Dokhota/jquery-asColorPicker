/*! asColorInput - v0.1.3 - 2014-06-26
* https://github.com/amazingSurge/jquery-asColorInput
* Copyright (c) 2014 amazingSurge; Licensed GPL */
!function(a){a.asColorInput.registerComponent("gradient",{degree:1,count:0,markers:[],current:null,defaults:{gradientText:"Gradient",cancelText:"Cancel",keepMode:!1,parse:function(a){var b=/gradient\(\s*(\d{1,3})deg\s*,((?:\s*(#([a-f0-9]{6}|[a-f0-9]{3})|((rgb|rgba|hsl|hsla)\([^\)]*\)))\s*(\d{1,3}%)\s*\,?)+)\)/,c=/(#([^\s]+)|((rgb|rgba|hsl|hsla)\([^\)]*\)))\s*(\d{1,3}%)/g;return null===b.exec(a)?null:{degree:b.exec(a)[1],markers:b.exec(a)[2].match(c)}},format:function(a){return a?a:void 0}},init:function(b,c){var d=this;this.options=a.extend(this.defaults,c);var e='<div class="'+b.namespace+'-gradient-controll"><a href="#" class="'+b.namespace+'-gradient-trigger">'+this.options.gradientText+'</a><a href="#" class="'+b.namespace+'-gradient-cancel">'+this.options.cancelText+'</a></div><div class="'+b.namespace+'-gradient"><div class="'+b.namespace+'-gradient-panel"><div class="'+b.namespace+'-gradient-markers"></div></div><div class="'+b.namespace+'-gradient-wheel"><i></i></div><input class="'+b.namespace+'-gradient-degree" type="text" value="360" size="3" /></div>';this.api=b,this.classes={enable:b.namespace+"-gradient_enable",marker:b.namespace+"-gradient-marker",active:b.namespace+"-gradient-marker_active"},this.isOpened=!1,this.initialized=!1,this.$doc=a(document),this.$template=a(e).appendTo(b.$dropdown),this.$controll=d.$template.eq(0),this.$trigger=this.$controll.find("."+b.namespace+"-gradient-trigger"),this.$cancel=this.$controll.find("."+b.namespace+"-gradient-cancel"),this.$gradient=this.$template.eq(1),this.$panel=this.$gradient.find("."+b.namespace+"-gradient-panel"),this.$markers=this.$gradient.find("."+b.namespace+"-gradient-markers"),this.$wheel=this.$gradient.find("."+b.namespace+"-gradient-wheel"),this.$pointer=this.$wheel.find("i"),this.$degree=this.$gradient.find("."+b.namespace+"-gradient-degree"),this.g_input.init(this),this.g_controll.init(this),this.g_panel.init(this),this.g_wheel.init(this),this.g_degree.init(this),b.$element.on("asColorInput::ready",function(a,b){"gradient"===b.options.mode&&(null!=(d.value=d.options.parse(d.api.gradient))&&(d.keepGradient(d),d.g_input.getMarkers(d.value,d)),d.options.keepMode&&d.keepGradient(d))})},keepGradient:function(a){a.width=a.$markers.width(),a.isOpened=!0,a.$gradient.addClass(a.classes.enable),a.api.isGradient=!0,a.g_controll.makeGradient(a),a.api.position()},g_input:{init:function(a){this.bind(a)},bind:function(a){var b=this;a.api.$element.on("keyup",function(c){a.api.isGradient&&(27===c.keyCode?a.api.close():13===c.keyCode&&null!=(a.value=a.options.parse(a.api.$element.val()))&&(b.getMarkers(a.value,a),a.api.update({},"input"),a.api.$element.focus()))})},getMarkers:function(a,b){var c=a.markers;b.$markers.children().remove(),b.markers=[],b.count=0,b.g_wheel.setDegree(a.degree,b);for(var d in c)b.api.color.from(c[d]),percent=parseInt(c[d].match(/[^\,\(]\)*\s+(\d{1,3})%/)[1]),b.g_panel.makeMarker(b.api.color,percent,b),b.api.set(b.api.color)}},g_controll:{init:function(a){var b=this;this.bind(a),a.api.$element.on("asColorInput::close",function(){return a.api.isGradient&&b.setGradient(a),!1})},bind:function(a){var b=this,c=a.api;a.$trigger.on("click",function(){return a.options.keepMode?!1:(a.isOpened?(a.$gradient.removeClass(a.classes.enable),b.setGradient(a),c.isGradient=!1,c.set(c.originalColor)):(a.width=a.$markers.width(),a.$gradient.addClass(a.classes.enable),c.isGradient=!0,b.makeGradient(a),c.$element.focus()),c.position(),a.isOpened=!a.isOpened,!1)}),a.$cancel.on("click",function(){return c.color.from("#000"),c.update({}),a.count=0,b.retrieve(a),!1})},setGradient:function(a){var b=this;this.origin={},this.origin.markers=[],a.markers.map(function(a){var c={color:a.color,percent:a.percent};b.origin.markers.push(c)}),this.origin.degree=a.degree},makeGradient:function(a){var b=a.markers,c=a.api,d="gradient("+(a.degree?a.degree:0)+"deg,",e="",f="",g=this.getPrefix();return b.sort(function(a,b){return a.percent>b.percent}),b.map(function(a,b,c){d+=a.color+" "+a.percent+"%,",b===c.length-1?(e+="color-stop("+a.percent/100+","+a.color+")",f+=a.color+" "+a.percent+"%"):(e+="color-stop("+a.percent/100+","+a.color+"),",f+=a.color+" "+a.percent+"%,")}),d=d.substring(0,d.length-1),d+=")",c.gradient=g+"linear-"+d,c._trigger("gradientChange",d),c.$element.val(d),"-webkit-"===g&&(a.$panel[0].style.backgroundImage=g+"gradient(linear, left top, right top, "+e+")"),a.$panel[0].style.backgroundImage=g+"linear-gradient(left, "+f+")",c.components.trigger.update(c),d},retrieve:function(a){a.markers.map(function(a){a.$element.blur(),a.$element.remove()}),a.markers=[],a.g_panel.makeMarker("#fff",0,a),a.g_panel.makeMarker("#000",100,a),a.g_wheel.setDegree(0,a),this.makeGradient(a)},getPrefix:function(){var a=window.navigator.userAgent,b="";return/MSIE/g.test(a)?b="-ms-":/Firefox/g.test(a)?b="-moz-":/(WebKit)/i.test(a)?b="-webkit-":/Opera/g.test(a)&&(b="-o-"),b}},g_panel:{init:function(a){this.makeMarker("#fff",0,a),this.makeMarker("#000",100,a),this.bind(a),a.api.$element.on("asColorInput::change",function(b,c){a.current&&a.api.isGradient&&!a.api.clear?(0===c.color.value.a&&(c.color.value.a=1),a.current.setColor(c.color.toRGBA()),a.g_controll.makeGradient(a),a.api._trigger("apply")):a.api.clear&&(a.count=0,a.g_controll.retrieve(a),a.api.gradient="")})},bind:function(a){var b=this;a.$markers.on("mousedown.asColorInput",function(c){var d=c.which?3===c.which:2===c.button;if(d)return!1;var e=c.pageX-a.$markers.offset().left,f=Math.round(e/a.width*100);return b.makeMarker("#fff",f,a),a.g_controll.makeGradient(a),!1})},makeMarker:function(b,c,d){var e=this,f=d.$doc,g=function(){this.color=b,this.percent=c,this._id=++d.count,this.$element=a('<span class="'+d.classes.marker+'"><i></i></span>').attr("tabindex",0).data("id",this._id),this.$element.appendTo(d.$markers),this.$element.on("mousedown.asColorInput",function(a){var b=a.which?3===a.which:2===a.button;return b?!1:(e.mousedown(a,this,d),!1)})};g.prototype.setColor=function(a){this.color=a,this.$element.find("i").css({background:a})},g.prototype.setPercent=function(a){this.percent=a,this.$element.css({left:a+"%"})};var h=new g;return h.setPercent(c),h.setColor(b),d.markers.push(h),null!==d.current&&(d.api.originalColor=d.current.color,d.api._trigger("apply")),d.$markers.children().removeClass(d.classes.active),d.current=h,h.$element.addClass(d.classes.active).focus(),h.hasBinded=!1,h.$element.on("focus",function(){h.hasBinded||(f.on("keydown."+h._id,function(a){var b=a.keyCode||a.which;if(46===b){if(d.count<=2)return;e.del(h,d),d.g_controll.makeGradient(d),d.$markers.children().eq(d.count-1).addClass(d.classes.active).focus()}}),h.hasBinded=!0)}).on("blur",function(){f.off("keydown."+h._id),h.hasBinded=!1}),h},mousedown:function(b,c,d){var e,f=this,g=d.api,h=a(c).data("id");a.each(d.markers,function(a,b){b._id===h&&(e=b)}),d.current!==e&&(g.originalColor=d.current.color,d.current.$element.removeClass(d.classes.active),d.current=e,e.$element.addClass(d.classes.active));var i,j=a(c).position().left,k=b.pageX;return g.set(e.color),this.mousemove=function(a){i=a.pageX||k;var b=j+i-k;return f.move(e,b,d),!1},this.mouseup=function(){return a(document).off({mousemove:this.mousemove,mouseup:this.mouseup}),!1},a(document).on({mousemove:a.proxy(this.mousemove,this),mouseup:a.proxy(this.mouseup,this)}),a(c).focus(),!1},move:function(a,b,c){b=Math.max(0,Math.min(c.width,b));var d=Math.round(b/c.width*100);a.setPercent(d),c.g_controll.makeGradient(c)},del:function(a,b){b.count-=1,a.$element.blur(),a.$element.remove(),b.markers.splice(b.markers.indexOf(a),1)}},g_wheel:{init:function(a){var b=this;this.bind(a),setTimeout(function(){b.setDegree(0,a),a.initialized=!0},0)},bind:function(a){var b=this;a.$wheel.on("mousedown.asColorInput",function(c){var d=c.which?3===c.which:2===c.button;return d?!1:(b.mousedown(c,a),!1)})},mousedown:function(b,c){var d=c.$wheel.offset(),e=c.$wheel.width()/2,f=d.left+e,g=d.top+e,h=c.$doc,i=this;this.r=e,this.wheelMove=function(a){var b=a.pageX-f,d=g-a.pageY,h=i.getPosition(b,d),j=i.calDegree(h.x,h.y);i._setDegree(j,c);var k=i.calPointer(j,e);c.$pointer.css({left:k.x,top:k.y})},this.wheelMouseup=function(){return h.off({mousemove:this.wheelMove,mouseup:this.wheelMouseup}),!1},h.on({mousemove:a.proxy(this.wheelMove,this),mouseup:a.proxy(this.wheelMouseup,this)}),this.wheelMove(b)},getPosition:function(a,b){var c=this.r,d=a/Math.sqrt(a*a+b*b)*c,e=b/Math.sqrt(a*a+b*b)*c;return{x:d,y:e}},calDegree:function(a,b){var c=Math.round(Math.atan(Math.abs(b/a))*(180/Math.PI));return 0>=a&&b>0?180-c:0>=a&&0>=b?c+180:a>0&&0>=b?360-c:a>0&&b>0?c:void 0},_setDegree:function(a,b){b.degree=a,b.$degree.val(a),b.initialized&&b.g_controll.makeGradient(b)},setDegree:function(a,b){if(b.degree===a)return!1;var c=this.r||b.$wheel.width()/2,d=this.calPointer(a,c);b.$pointer.css({left:d.x,top:d.y}),this._setDegree(a,b)},calPointer:function(a,b){var c=Math.cos(a*Math.PI/180)*b,d=Math.sin(a*Math.PI/180)*b;return{x:b+c,y:b-d}}},g_degree:{init:function(a){this.bind(a)},bind:function(b){b.$degree.on("blur.asColorInput",function(){var a=parseInt(this.value,10);return b.g_wheel.setDegree(a,b),!1}).on("keydown.asColorInput",function(b){var c=b.keyCode||b.which;return 13===c?(a(this).blur(),!1):void 0})}},get:function(){var a=this.options.format(self.value);return a},destory:function(){this.$element.off("click"),this.$element.remove()}})}(jQuery);