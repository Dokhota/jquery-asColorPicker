/*! colorInput - v0.1.3 - 2014-03-25
* https://github.com/amazingSurge/jquery-colorInput
* Copyright (c) 2014 amazingSurge; Licensed GPL */
(function(t){t.colorInput.registerComponent("gradient",{degree:1,count:0,markers:[],current:null,init:function(e){var i=this,o='<a href="#" class="'+e.namespace+'-gradient-trigger">Gradient</a>'+'<div class="'+e.namespace+'-gradient">'+'<div class="'+e.namespace+'-gradient-panel">'+'<div class="'+e.namespace+'-gradient-markers"></div>'+"</div>"+'<div class="'+e.namespace+'-gradient-wheel">'+"<i></i>"+"</div>"+'<input class="'+e.namespace+'-gradient-degree" type="text" value="360" size="3" />'+"</div>";this.api=e,this.classes={show:e.namespace+"-gradient"+"_show",marker:e.namespace+"-gradient-marker",active:e.namespace+"-gradient-marker_active"},this.isOpened=!1,this.$doc=t(document),this.$template=t(o).appendTo(e.$picker),this.$trigger=this.$template.eq(0),this.$gradient=this.$template.eq(1),this.$panel=this.$gradient.find("."+e.namespace+"-gradient-panel"),this.$markers=this.$gradient.find("."+e.namespace+"-gradient-markers"),this.$wheel=this.$gradient.find("."+e.namespace+"-gradient-wheel"),this.$pointer=this.$wheel.find("i"),this.$degree=this.$gradient.find("."+e.namespace+"-gradient-degree"),this.$trigger.on("click",function(){return i.isOpened?(i.$gradient.removeClass(i.classes.show),e.isGradient=!1):(i.$gradient.addClass(i.classes.show),e.isGradient=!0),i.isOpened=!i.isOpened,!1}),this.$markers.on("mousedown.colorinput",function(t){var e=t.which?3===t.which:2===t.button;if(e)return!1;var o=t.pageX-i.$markers.offset().left,a=Math.round(100*(o/i.width));return i.makeMarker("#fff",a),i.makeGradient(),!1}),this.$wheel.on("mousedown.colorInput",function(t){var e=t.which?3===t.which:2===t.button;return e?!1:(i.wheelMousedown(t),!1)}),e.$element.on("colorInput::ready",function(){i.width=i.$markers.width()}),e.$element.on("colorInput::change",function(t,e){i.current&&(i.current.setColor(e.color.toRGBA()),i.makeGradient())}),this.$degree.on("blur.colorInput",function(){var t=parseInt(this.value,10);return i.setDegree(t),!1}),this.makeMarker("#fff",0),this.makeMarker("#000",100),this.setDegree(0)},mousedown:function(e,i){var o,a=t(i).data("id");t.each(this.markers,function(t,e){e._id===a&&(o=e)}),this.current=o;var s,n=t(i).position().left,h=e.pageX,r=this.api;return r.makeUnselectable(),r.set(o.color),this.mousemove=function(t){s=t.pageX||h;var e=n+s-h;return this.move(o,e),!1},this.mouseup=function(){return t(document).off({mousemove:this.mousemove,mouseup:this.mouseup}),r.cancelUnselectable(),!1},t(document).on({mousemove:t.proxy(this.mousemove,this),mouseup:t.proxy(this.mouseup,this)}),t(i).focus(),!1},move:function(t,e){e=Math.max(0,Math.min(this.width,e));var i=Math.round(100*(e/this.width));t.setPercent(i),this.makeGradient()},makeMarker:function(e,i){var o=this,a=this.$doc,s=function(){this.color=e,this.percent=i,this._id=++o.count,this.$element=t('<span class="'+o.classes.marker+'"><i></i></span>').attr("tabindex",0).data("id",this._id),this.$element.appendTo(o.$markers),this.$element.on("mousedown.colorInput",function(t){var e=t.which?3===t.which:2===t.button;return e?!1:(o.mousedown.call(o,t,this),!1)})};s.prototype.setColor=function(t){this.color=t,this.$element.find("i").css({background:t})},s.prototype.setPercent=function(t){this.percent=t,this.$element.css({left:t+"%"})};var n=new s;return n.setPercent(i),n.setColor(e),this.markers.push(n),this.current=n,n.hasBinded=!1,n.$element.on("focus",function(){n.hasBinded||(a.on("keydown."+n._id,function(t){var e=t.keyCode||t.which;46===e&&o.del(n)}),n.$element.addClass(o.classes.active),n.hasBinded=!0)}).on("blur",function(){a.off("keydown."+n._id),n.removeClass(o.classes.active),n.hasBinded=!1}),n},makeGradient:function(){var e=this.markers,i=this.api,o=this,a="gradient("+this.degree+"deg,",s="",n="";e.sort(function(t,e){return t.percent>e.percent}),e.map(function(t,e,i){a+=t.color+" "+t.percent+"%,",e===i.length-1?(s+="color-stop("+t.percent/100+","+t.color+")",n+=t.color+" "+t.percent+"%"):(s+="color-stop("+t.percent/100+","+t.color+"),",n+=t.color+" "+t.percent+"%,")}),a=a.substring(0,a.length-1),a+=")",i.gradient=a,i._trigger("gradientChange",a);var h=["-moz-linear-gradient(left, "+n+")","-webkit-gradient(linear, left top, right top, "+s+")","-webkit-linear-gradient(left, "+n+")","-o-linear-gradient(left, "+n+")"];return t.each(h,function(t,e){o.$panel[0].style.backgroundImage=e}),a},getPosition:function(t,e){var i=this.r,o=t/Math.sqrt(t*t+e*e)*i,a=e/Math.sqrt(t*t+e*e)*i;return{x:o,y:a}},calDegree:function(t,e){var i=Math.round(Math.atan(Math.abs(e/t))*(180/Math.PI));return 0>=t&&e>0?180-i:0>=t&&0>=e?i+180:t>0&&0>=e?360-i:t>0&&e>0?i:void 0},_setDegree:function(t){this.deg=t,this.$degree.val(t),this.makeGradient()},setDegree:function(t){if(this.degree===t)return!1;var e=this.r||this.$wheel.width()/2,i=this.calPointer(t,e);this.$pointer.css({left:i.x,top:i.y}),this._setDegree(t)},calPointer:function(t,e){var i=Math.cos(t*Math.PI/180)*e,o=Math.sin(t*Math.PI/180)*e;return{x:e+i,y:e-o}},wheelMousedown:function(e){var i=this.$wheel.offset(),o=this.$wheel.width()/2,a=i.left+o,s=i.top+o,n=this.$doc;this.r=o,this.wheelMove=function(t){var e=t.pageX-a,i=s-t.pageY,n=this.getPosition(e,i),h=this.calDegree(n.x,n.y);this._setDegree(h);var r=this.calPointer(h,o);this.$pointer.css({left:r.x,top:r.y})},this.wheelMouseup=function(){return n.off({mousemove:this.wheelMove,mouseup:this.wheelMouseup}),!1},n.on({mousemove:t.proxy(this.wheelMove,this),mouseup:t.proxy(this.wheelMouseup,this)}),this.wheelMove(e)},del:function(t){this.$doc.off("keydown."+t._id),t.$element.remove(),this.markers.splice(this.markers.indexOf(t),1),this.makeGradient()},destory:function(){this.$element.off("click"),this.$element.remove()}})})(jQuery);